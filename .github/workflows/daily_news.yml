name: Daily Finnhub News

on:
schedule:
# 6 PM New York Time.
# New York is EST (UTC-5) or EDT (UTC-4).
# In Winter (Standard Time), 18:00 NY = 23:00 UTC.
# In Summer (Daylight Saving), 18:00 NY = 22:00 UTC.
# Cron uses UTC. Setting to 23:00 UTC covers Standard Time (Winter).
- cron: '0 23 * * *'
workflow_dispatch:

permissions:
contents: write

concurrency:
group: daily-finnhub-news
cancel-in-progress: false

jobs:
fetch-news:
runs-on: ubuntu-latest
steps:
- name: Checkout repository
uses: actions/checkout@v4
with:
fetch-depth: 0

```
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.12'

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install finnhub-python

  - name: Fetch Daily News
    env:
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
    run: python scripts/fetch_daily_news.py

  - name: Get current date
    run: echo "DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

  - name: Move artifacts to workflowdata folder (one file per day)
    shell: bash
    run: |
      set -euo pipefail
      mkdir -p workflowdata

      # Pick the newest matching output file (in case script outputs more than one)
      latest="$(ls -1t news_output_*.json 2>/dev/null | head -n 1 || true)"
      if [[ -z "${latest}" ]]; then
        echo "No news_output_*.json found; nothing to move."
        exit 0
      fi

      target="workflowdata/news_${DATE}.json"
      mv "${latest}" "${target}"
      echo "Moved ${latest} -> ${target}"

  - name: Commit and push daily file
    shell: bash
    run: |
      set -euo pipefail
      git config --local user.email "github-actions[bot]@users.noreply.github.com"
      git config --local user.name "github-actions[bot]"

      git pull --rebase origin main

      git add workflowdata/news_${DATE}.json

      if git diff --staged --quiet; then
        echo "No changes to commit."
        exit 0
      fi

      git commit -m "chore: add daily news ${DATE}"
      git push

  - name: Upload News Artifact
    uses: actions/upload-artifact@v4
    with:
      name: daily-news-json-${{ env.DATE }}
      path: workflowdata/news_${{ env.DATE }}.json
      retention-days: 15
```
